rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    // Helper functions

    function isAuthenticated() {

      return request.auth != null;

    }

    

    // For now, allow all authenticated users (client-side enforces admin check)

    function isAdmin() {

      return isAuthenticated();

    }

    

    // GLOBAL CHAMPION DATA

    match /champions/global {

      allow read: if isAuthenticated();

      allow write: if isAdmin();

    }

    

    // GLOBAL SETTINGS

    match /settings/global {

      allow read: if isAuthenticated();

      allow write: if isAdmin();

    }

    // WORKSPACES

    match /workspaces/{workspaceId} {

      match /metadata/info {

        allow read: if isAuthenticated();

        allow create, update, delete: if isAdmin();

      }

      match /users/{userId} {

        allow read: if isAuthenticated();

        allow create: if isAdmin() || request.auth.uid == userId;

        allow update: if isAuthenticated();

        allow delete: if isAdmin();

      }

      match /drafts/{document=**} {

        allow read, write: if isAuthenticated();

      }

      match /savedDrafts/{draftId} {

        allow read, write: if isAuthenticated();

      }
      
      // LCU Draft data (from external LCU client)
      match /lcuDrafts/{lobbyId} {
        // Workspace members can read LCU draft data
        allow read: if isAuthenticated();
        // Writes are handled server-side via Netlify function (bypasses rules)
        allow write: if false; // Explicitly deny client-side writes
      }
      
      // Scouting data - direct collections under workspace (like drafts)
      match /scoutingPlayers/{playerId} {
        // Workspace members can read player list
        allow read: if isAuthenticated();
        // Only admins can add/update/delete players
        allow write: if isAdmin();
      }
      
      match /scoutingData/{playerId} {
        // Workspace members can read scouting data
        allow read: if isAuthenticated();
        // Only admins can write scouting data
        allow write: if isAdmin();
      }
      
      match /scoutingSettings/{document=**} {
        // Workspace members can read scouting settings (team names)
        allow read: if isAuthenticated();
        // Only admins can write scouting settings
        allow write: if isAdmin();
      }
      
      match /scoutingTeams/{teamId} {
        // Workspace members can read teams
        allow read: if isAuthenticated();
        // Only admins can write teams
        allow write: if isAdmin();
      }
      
      // SERIES COLLECTION
      match /series/{seriesId} {
        // Workspace members can read series
        allow read: if isAuthenticated();
        // Workspace members can create/update/delete series
        allow write: if isAuthenticated();
        
        // NOTES subcollection under series
        match /notes/{noteId} {
          // Workspace members can read notes
          allow read: if isAuthenticated();
          // Workspace members can create/update/delete notes
          allow write: if isAuthenticated();
        }
      }
      
      // DRAWING COLLECTION
      match /drawing/{view} {
        // Workspace members can read drawings
        allow read: if isAuthenticated();
        
        // STROKES subcollection under drawing
        match /strokes/{strokeId} {
          // Workspace members can read strokes
          allow read: if isAuthenticated();
          // Workspace members can create/update strokes
          allow create, update: if isAuthenticated();
          // Only admins can delete strokes (for clear canvas)
          allow delete: if isAdmin();
        }
      }
    }
  }
}
